<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:fragment="head">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: 'SplitFriend'">SplitFriend</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Split expenses with friends and family">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SplitFriend">

    <!-- PWA Manifest -->
    <link rel="manifest" th:href="@{/manifest.json}">

    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" sizes="32x32" th:href="@{/icons/icon-96x96.png}">
    <link rel="apple-touch-icon" sizes="180x180" th:href="@{/icons/icon-192x192.png}">

    <link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.2/css/bootstrap.min.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <script>
        // Apply theme before page renders to prevent flash
        (function() {
            var theme = localStorage.getItem('splitfriend-theme') || 'theme-emerald';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>
<body>
<div th:fragment="navbar">
    <nav class="navbar navbar-expand-lg navbar-dark main-navbar">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" th:href="@{/dashboard}">
                <i class="bi bi-wallet2 me-2 fs-4"></i>
                <span class="fw-bold">SplitFriend</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto" sec:authorize="isAuthenticated()">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/dashboard}">
                            <i class="bi bi-speedometer2 me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/groups}">
                            <i class="bi bi-people me-1"></i> Groups
                        </a>
                    </li>
                    <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                        <a class="nav-link" th:href="@{/admin}">
                            <i class="bi bi-gear me-1"></i> Admin
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav" sec:authorize="isAuthenticated()">
                    <!-- Theme Switcher -->
                    <li class="nav-item dropdown me-2">
                        <a class="nav-link dropdown-toggle" href="#" id="themeDropdown" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-palette"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end theme-dropdown">
                            <li><h6 class="dropdown-header"><i class="bi bi-brush me-1"></i> Color Theme</h6></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-emerald">
                                <span class="theme-dot" style="background: #10b981;"></span> Emerald
                            </a></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-ocean">
                                <span class="theme-dot" style="background: #0ea5e9;"></span> Ocean Blue
                            </a></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-purple">
                                <span class="theme-dot" style="background: #8b5cf6;"></span> Royal Purple
                            </a></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-sunset">
                                <span class="theme-dot" style="background: #f59e0b;"></span> Sunset Gold
                            </a></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-rose">
                                <span class="theme-dot" style="background: #f43f5e;"></span> Rose
                            </a></li>
                            <li><a class="dropdown-item theme-option" href="#" data-theme="theme-slate">
                                <span class="theme-dot" style="background: #475569;"></span> Slate Dark
                            </a></li>
                        </ul>
                    </li>
                    <!-- User Dropdown -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                           data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-1"></i>
                            <span sec:authentication="principal.name">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" th:href="@{/profile}">
                                <i class="bi bi-person me-2"></i> Profile
                            </a></li>
                            <li><a class="dropdown-item" th:href="@{/setup-2fa}">
                                <i class="bi bi-shield-lock me-2"></i> 2FA Settings
                            </a></li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="installPWA(); return false;" id="pwa-install-btn">
                                    <i class="bi bi-download me-2"></i> Install App
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form th:action="@{/logout}" method="post" class="d-inline">
                                    <button type="submit" class="dropdown-item">
                                        <i class="bi bi-box-arrow-right me-2"></i> Logout
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>
                </ul>
                <ul class="navbar-nav" sec:authorize="!isAuthenticated()">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/login}">
                            <i class="bi bi-box-arrow-in-right me-1"></i> Login
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>

<div th:fragment="alerts">
    <div th:if="${message}" class="alert alert-success alert-dismissible fade show d-flex align-items-center" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span th:text="${message}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show d-flex align-items-center" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
</div>

<div th:fragment="scripts">
    <script th:src="@{/webjars/jquery/3.7.1/jquery.min.js}"></script>
    <script th:src="@{/webjars/bootstrap/5.3.2/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/app.js}"></script>
</div>
</body>
</html>
